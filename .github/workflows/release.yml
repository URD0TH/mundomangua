name: Release Userscript

on:
  push:
    tags:
      - 'v*' # cualquier tag que empiece con ‚Äúv‚Äù

  workflow_dispatch:  # Ejecuci√≥n manual desde la UI de GitHub
    inputs:
      tag_name:
        description: 'Tag de versi√≥n (ej: v1.2.3)'
        required: true
        type: string
      create_tag:
        description: 'Crear el tag si no existe'
        required: false
        type: boolean
        default: false

permissions:
  contents: write  # Permiso necesario para poder hacer push, crear releases, modificar contenido

jobs:
  release:
    runs-on: ubuntu-latest  # Usar un runner en Ubuntu

    steps:
      - name: Checkout target repository
        uses: actions/checkout@v6
        with:
          repository: URD0TH/mundomangua  # Clona ese repositorio
          fetch-depth: 0  # Obtener todo el historial, tags, ramas

      - name: Configure git user
        run: |
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"

      - name: Determine Tag Name
        id: get_tag
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "TAG_NAME=${{ inputs.tag_name }}" >> $GITHUB_ENV
            echo "IS_MANUAL=true" >> $GITHUB_ENV
          else
            echo "TAG_NAME=${{ github.ref_name }}" >> $GITHUB_ENV
            echo "IS_MANUAL=false" >> $GITHUB_ENV
          fi

      - name: Create tag if requested (Manual only)
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.create_tag }}
        run: |
          # Verificar si el tag ya existe
          if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
            echo "‚ö†Ô∏è  El tag $TAG_NAME ya existe"
          else
            echo "‚úÖ Creando tag $TAG_NAME"
            git tag "$TAG_NAME"
            git push origin "$TAG_NAME"
          fi

      - name: Verify tag exists
        run: |
          # Verificar que el tag existe
          if ! git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
            echo "‚ùå Error: El tag $TAG_NAME no existe. Usa la opci√≥n 'create_tag' para crearlo."
            exit 1
          fi
          echo "‚úÖ Tag $TAG_NAME verificado"

      - name: Update script metadata
        run: |
          # Obtener la versi√≥n sin la "v" inicial
          VERSION=${TAG_NAME#v}
          # URL raw para Tampermonkey
          DOWNLOAD_URL="https://raw.githubusercontent.com/URD0TH/mundomangua/main/userscript/Skip-Intro-and-Next-Chapter-Buttons.js"

          echo "üìù Actualizando metadata..."
          echo "   Tag: $TAG_NAME"
          echo "   Versi√≥n: $VERSION"
          echo "   URL: $DOWNLOAD_URL"

          # Modificar dentro del script las l√≠neas de metadata:
          # @version, @downloadURL y @updateURL con los valores calculados
          sed -i "s|// @version      .*|// @version      ${VERSION}|" userscript/Skip-Intro-and-Next-Chapter-Buttons.js
          sed -i "s|// @downloadURL  .*|// @downloadURL  ${DOWNLOAD_URL}|" userscript/Skip-Intro-and-Next-Chapter-Buttons.js
          sed -i "s|// @updateURL    .*|// @updateURL    ${DOWNLOAD_URL}|" userscript/Skip-Intro-and-Next-Chapter-Buttons.js

          # Validaciones
          if ! grep -q "// @version      ${VERSION}" userscript/Skip-Intro-and-Next-Chapter-Buttons.js; then
            echo "‚ùå Error al actualizar @version"
            exit 1
          fi
          if ! grep -q "// @downloadURL  ${DOWNLOAD_URL}" userscript/Skip-Intro-and-Next-Chapter-Buttons.js; then
            echo "‚ùå Error al actualizar @downloadURL"
            exit 1
          fi
          echo "‚úÖ Metadata actualizada correctamente"

      - name: Commit updated script
        run: |
          git add userscript/Skip-Intro-and-Next-Chapter-Buttons.js
          if git commit -m "Update script to ${TAG_NAME} for release"; then
            echo "‚úÖ Commit creado"
            echo "üì§ Enviando cambios a main..."
            git push origin HEAD:main
          else
            echo "‚ö†Ô∏è  Sin cambios para commit"
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v2.4.1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # Token autom√°tico para autenticarse
        with:
          tag_name: ${{ env.TAG_NAME }}
          name: Skip Intro Buttons ${{ env.TAG_NAME }}
          draft: false
          prerelease: false
          files: userscript/Skip-Intro-and-Next-Chapter-Buttons.js
          generate_release_notes: true
