name: Release Userscript

on:
  workflow_dispatch:  # Ejecuci√≥n manual desde la UI de GitHub
    inputs:
      tag_name:
        description: 'Tag de versi√≥n (ej: v1.2.3)'
        required: true
        type: string
      create_tag:
        description: 'Crear el tag si no existe'
        required: false
        type: boolean
        default: false

permissions:
  contents: write  # Permiso necesario para poder hacer push, crear releases, modificar contenido

jobs:
  release:
    runs-on: ubuntu-latest  # Usar un runner en Ubuntu

    steps:
      - name: Checkout target repository
        uses: actions/checkout@v6
        with:
          repository: URD0TH/mundomangua  # Clona ese repositorio
          fetch-depth: 0  # Obtener todo el historial, tags, ramas

      - name: Configure git user
        run: |
          # Configura usuario para los commits autom√°ticos (formato recomendado por GitHub)
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"

      - name: Create tag if requested
        if: ${{ inputs.create_tag }}
        run: |
          TAG_NAME=${{ inputs.tag_name }}
          # Verificar si el tag ya existe
          if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
            echo "‚ö†Ô∏è  El tag $TAG_NAME ya existe"
          else
            echo "‚úÖ Creando tag $TAG_NAME"
            git tag "$TAG_NAME"
            git push origin "$TAG_NAME"
          fi

      - name: Verify tag exists
        run: |
          TAG_NAME=${{ inputs.tag_name }}
          # Verificar que el tag existe (ya sea porque se cre√≥ o porque ya exist√≠a)
          if ! git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
            echo "‚ùå Error: El tag $TAG_NAME no existe. Usa la opci√≥n 'create_tag' para crearlo."
            exit 1
          fi
          echo "‚úÖ Tag $TAG_NAME verificado"

      - name: Update script metadata
        run: |
          # Usar el tag del input en lugar de github.ref_name
          TAG_NAME=${{ inputs.tag_name }}
          # Obtener la versi√≥n sin la "v" inicial, ej. "1.2.3"
          VERSION=${TAG_NAME#v}
          # Usar URL raw de GitHub para que Tampermonkey pueda detectar actualizaciones
          # El archivo en main siempre estar√° actualizado porque el workflow hace commit antes del release
          DOWNLOAD_URL="https://raw.githubusercontent.com/URD0TH/mundomangua/main/userscript/Skip-Intro-and-Next-Chapter-Buttons.js"

          echo "üìù Actualizando metadata del script..."
          echo "   Tag: $TAG_NAME"
          echo "   Versi√≥n: $VERSION"
          echo "   URL (raw para Tampermonkey): $DOWNLOAD_URL"

          # Modificar dentro del script las l√≠neas de metadata:
          # @version, @downloadURL y @updateURL con los valores calculados
          sed -i "s|// @version      .*|// @version      ${VERSION}|" userscript/Skip-Intro-and-Next-Chapter-Buttons.js
          sed -i "s|// @downloadURL  .*|// @downloadURL  ${DOWNLOAD_URL}|" userscript/Skip-Intro-and-Next-Chapter-Buttons.js
          sed -i "s|// @updateURL    .*|// @updateURL    ${DOWNLOAD_URL}|" userscript/Skip-Intro-and-Next-Chapter-Buttons.js

          # Validar que los cambios se aplicaron correctamente
          echo ""
          echo "üîç Validando cambios aplicados..."
          if grep -q "// @version      ${VERSION}" userscript/Skip-Intro-and-Next-Chapter-Buttons.js; then
            echo "‚úÖ @version actualizado correctamente"
          else
            echo "‚ùå Error: No se pudo actualizar @version"
            exit 1
          fi

          if grep -q "// @downloadURL  ${DOWNLOAD_URL}" userscript/Skip-Intro-and-Next-Chapter-Buttons.js; then
            echo "‚úÖ @downloadURL actualizado correctamente"
          else
            echo "‚ùå Error: No se pudo actualizar @downloadURL"
            exit 1
          fi

          if grep -q "// @updateURL    ${DOWNLOAD_URL}" userscript/Skip-Intro-and-Next-Chapter-Buttons.js; then
            echo "‚úÖ @updateURL actualizado correctamente"
          else
            echo "‚ùå Error: No se pudo actualizar @updateURL"
            exit 1
          fi

          echo ""
          echo "‚úÖ Todas las validaciones pasaron exitosamente"

      - name: Commit updated script
        run: |
          TAG_NAME=${{ inputs.tag_name }}
          # A√±adir el archivo modificado al staging
          git add userscript/Skip-Intro-and-Next-Chapter-Buttons.js
          # Hacer commit con el mensaje que indica la versi√≥n del tag
          if git commit -m "Update script to ${TAG_NAME} for release"; then
            echo "‚úÖ Commit creado exitosamente"
          else
            echo "‚ö†Ô∏è  No hay cambios para hacer commit (el archivo ya estaba actualizado)"
          fi

      - name: Push changes
        run: |
          # Enviar el commit al repositorio remoto, a la rama principal
          echo "üì§ Enviando cambios a la rama main..."
          if git push origin HEAD:main; then
            echo "‚úÖ Cambios enviados exitosamente"
          else
            echo "‚ùå Error al hacer push. Verifica que tengas permisos y que la rama main no est√© protegida."
            exit 1
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v2.4.1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # Token autom√°tico para autenticarse
        with:
          tag_name: ${{ inputs.tag_name }}  # El tag bajo el cual se crea el release
          name: Skip Intro Buttons ${{ inputs.tag_name }}  # Nombre del release
          draft: false
          prerelease: false
          files: userscript/Skip-Intro-and-Next-Chapter-Buttons.js  # Incluir el archivo modificado como asset
          generate_release_notes: true  # Generar notas de release autom√°ticamente
